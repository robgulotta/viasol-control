# Firmware Outline

## Master Control
### UI
#### Settings
- allow for temperature setting for tank limit eeprom
- allow for PV shunt values to be entered and stored in eeprom
- allow for time and date to be set
- allow for aux relay logic implementation (v2)
- assign pv AC diversion relay
- name aux temp sensors
- connect to wifi
- connect to mqtt
- PV string configuration, VMP, VOC, I per string
- Remote Comm shunt specifications
- heater resistance learn signal
- heater resistance manual programming

#### Control
- allow for manual heater override and current detection, service mode
- allow for remote firmware upgrades

#### Interface
- http based form with fields to be remotely entered
- display/button interface for local redundancy
- mqtt commands for settings?

### MQTT
- report errors in command vs expected output
- report I, V, power
- report individual channel current, power, temp
- report detected leaks
- listen for diversion signal
- tank temp
- aux temps

### Comm with Remote
- enable/disable overall on safety or tank temp setpoint
- enable/disable diversion
- rx data

### Functions
- communicate necessary settings to remote
- report mqtt data
- thermostatic control of main pump and zone valves (maybe add thermostat call for heat connections for more zones or zone expansion module)
- differential control for pv hydronic additions
- local ac current detection for potential diversion disable
- communication with battery interface and current detect board (future)

## Remote Comm
### Heating Algorithm
- Leave one channel closed when PV voltage exceeds setpoint to begin to detect current flow
- Calibrate daily at 0 current when all channels are off
- Voltage based switching or perturb and observe power based switching
- detect resistance and current flow of each channel to create per channel step sequence (or in settings?)
- redetect channel power at each step of increased current?  or determine when detection step is compromised by low pv voltage during detection?
- activate pv diversion relay if present
- total cumulative power tally daily/monthly/lifetime (eeprom daily?)



